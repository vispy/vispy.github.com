


<!DOCTYPE html>
<html lang="en">
<head>
        <title>demo/gloo/mandelbrot_double &mdash; vispy</title>
    
    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link href="../../../_static/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../../../_static/css/custom.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">
    
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="../../../_static/js/bootstrap.min.js"></script>
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/js/jquery.anoslide.js"></script>
        <script type="text/javascript" src="../../../_static/js/carousel.js"></script>
        <link rel="top" title="vispy" href="../../../index.html" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="shortcut icon" href="../../../_static/favicon.ico">
</head>
<body class="container">
    <a href="http://vispy.org" class="logo"><img src="../../../_static/img/logo.png" alt=""></a>
    <div class="clearfix"></div>
    <div class="navbar">
        <div class="navbar-inner">
            <ul class="nav">
                <li><a href="http://vispy.org/index.html">Home</a></li>
<li><a href="http://vispy.org/gallery.html">Gallery</a></li>
<li><a href="http://api.vispy.org">Documentation</a></li>
<li><a href="https://github.com/vispy/vispy">Source</a></li>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45168532-1', 'vispy.org');
  ga('send', 'pageview');

</script>
            </ul>
            <form class="navbar-form pull-right" action="http://api.vispy.org/en/latest/search.html" method="get">
                <input type="text" class="search span3" name="q" placeholder="Search documentation ...">
                <input type="hidden" name="check_keywords" value="yes" >
                <input type="hidden" name="area" value="default" >
            </form>
        </div>
    </div>
    <div class="row">
        <div class="span9">
            
  <div class="section" id="demo-gloo-mandelbrot-double">
<h1>demo/gloo/mandelbrot_double<a class="headerlink" href="#demo-gloo-mandelbrot-double" title="Permalink to this headline">Â¶</a></h1>
<p>Example demonstrating the use of emulated double-precision floating point
numbers. Based off of mandelbrot.py.</p>
<p>The shader program emulates double-precision variables using a vec2 instead of
single-precision floats. Any function starting with ds_* operates on these
variables. See <a class="reference external" href="http://www.thasler.org/blog/?p=93">http://www.thasler.org/blog/?p=93</a>.</p>
<p>NOTE: Some NVIDIA cards optimize the double-precision code away. Results are
therefore hardware dependent.</p>
<img alt="../../../_images/demo__gloo__mandelbrot_double.png" src="../../../_images/demo__gloo__mandelbrot_double.png" />
<hr class="docutils" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example is based on <code class="docutils literal"><span class="pre">vispy.gloo</span></code> and thus uses GLSL
shading code, which is executed at the GPU and is
defined as multiline strings.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">vispy</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">gloo</span>

<span class="c"># Shader source code</span>
<span class="c"># -----------------------------------------------------------------------------</span>
<span class="n">vertex</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">attribute vec2 position;</span>

<span class="s">void main()</span>
<span class="s">{</span>
<span class="s">    gl_Position = vec4(position, 0, 1.0);</span>
<span class="s">}</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="n">fragment</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">#pragma optionNV(fastmath off)</span>
<span class="s">#pragma optionNV(fastprecision off)</span>

<span class="s">uniform vec2 inv_resolution_x;  // Inverse resolutions</span>
<span class="s">uniform vec2 inv_resolution_y;</span>
<span class="s">uniform vec2 center_x;</span>
<span class="s">uniform vec2 center_y;</span>
<span class="s">uniform vec2 scale;</span>
<span class="s">uniform int iter;</span>

<span class="s">// Jet color scheme</span>
<span class="s">vec4 color_scheme(float x) {</span>
<span class="s">    vec3 a, b;</span>
<span class="s">    float c;</span>
<span class="s">    if (x &lt; 0.34) {</span>
<span class="s">        a = vec3(0, 0, 0.5);</span>
<span class="s">        b = vec3(0, 0.8, 0.95);</span>
<span class="s">        c = (x - 0.0) / (0.34 - 0.0);</span>
<span class="s">    } else if (x &lt; 0.64) {</span>
<span class="s">        a = vec3(0, 0.8, 0.95);</span>
<span class="s">        b = vec3(0.85, 1, 0.04);</span>
<span class="s">        c = (x - 0.34) / (0.64 - 0.34);</span>
<span class="s">    } else if (x &lt; 0.89) {</span>
<span class="s">        a = vec3(0.85, 1, 0.04);</span>
<span class="s">        b = vec3(0.96, 0.7, 0);</span>
<span class="s">        c = (x - 0.64) / (0.89 - 0.64);</span>
<span class="s">    } else {</span>
<span class="s">        a = vec3(0.96, 0.7, 0);</span>
<span class="s">        b = vec3(0.5, 0, 0);</span>
<span class="s">        c = (x - 0.89) / (1.0 - 0.89);</span>
<span class="s">    }</span>
<span class="s">    return vec4(mix(a, b, c), 1.0);</span>
<span class="s">}</span>

<span class="s">vec2 ds_set(float a) {</span>
<span class="s">    // Create an emulated double by storing first part of float in first half</span>
<span class="s">    // of vec2</span>
<span class="s">    vec2 z;</span>
<span class="s">    z.x = a;</span>
<span class="s">    z.y = 0.0;</span>
<span class="s">    return z;</span>
<span class="s">}</span>

<span class="s">vec2 ds_add (vec2 dsa, vec2 dsb)</span>
<span class="s">{</span>
<span class="s">    // Add two emulated doubles. Complexity comes from carry-over.</span>
<span class="s">    vec2 dsc;</span>
<span class="s">    float t1, t2, e;</span>

<span class="s">    t1 = dsa.x + dsb.x;</span>
<span class="s">    e = t1 - dsa.x;</span>
<span class="s">    t2 = ((dsb.x - e) + (dsa.x - (t1 - e))) + dsa.y + dsb.y;</span>

<span class="s">    dsc.x = t1 + t2;</span>
<span class="s">    dsc.y = t2 - (dsc.x - t1);</span>
<span class="s">    return dsc;</span>
<span class="s">}</span>

<span class="s">vec2 ds_mul (vec2 dsa, vec2 dsb)</span>
<span class="s">{</span>
<span class="s">    vec2 dsc;</span>
<span class="s">    float c11, c21, c2, e, t1, t2;</span>
<span class="s">    float a1, a2, b1, b2, cona, conb, split = 8193.;</span>

<span class="s">    cona = dsa.x * split;</span>
<span class="s">    conb = dsb.x * split;</span>
<span class="s">    a1 = cona - (cona - dsa.x);</span>
<span class="s">    b1 = conb - (conb - dsb.x);</span>
<span class="s">    a2 = dsa.x - a1;</span>
<span class="s">    b2 = dsb.x - b1;</span>

<span class="s">    c11 = dsa.x * dsb.x;</span>
<span class="s">    c21 = a2 * b2 + (a2 * b1 + (a1 * b2 + (a1 * b1 - c11)));</span>

<span class="s">    c2 = dsa.x * dsb.y + dsa.y * dsb.x;</span>

<span class="s">    t1 = c11 + c2;</span>
<span class="s">    e = t1 - c11;</span>
<span class="s">    t2 = dsa.y * dsb.y + ((c2 - e) + (c11 - (t1 - e))) + c21;</span>

<span class="s">    dsc.x = t1 + t2;</span>
<span class="s">    dsc.y = t2 - (dsc.x - t1);</span>

<span class="s">    return dsc;</span>
<span class="s">}</span>

<span class="s">// Compare: res = -1 if a &lt; b</span>
<span class="s">//              = 0 if a == b</span>
<span class="s">//              = 1 if a &gt; b</span>
<span class="s">float ds_compare(vec2 dsa, vec2 dsb)</span>
<span class="s">{</span>
<span class="s">    if (dsa.x &lt; dsb.x) return -1.;</span>
<span class="s">    else if (dsa.x == dsb.x) {</span>
<span class="s">        if (dsa.y &lt; dsb.y) return -1.;</span>
<span class="s">        else if (dsa.y == dsb.y) return 0.;</span>
<span class="s">        else return 1.;</span>
<span class="s">    }</span>
<span class="s">    else return 1.;</span>
<span class="s">}</span>

<span class="s">void main() {</span>
<span class="s">    vec2 z_x, z_y, c_x, c_y, x, y, frag_x, frag_y;</span>
<span class="s">    vec2 four = ds_set(4.0);</span>
<span class="s">    vec2 point5 = ds_set(0.5);</span>

<span class="s">    // Recover coordinates from pixel coordinates</span>
<span class="s">    frag_x = ds_set(gl_FragCoord.x);</span>
<span class="s">    frag_y = ds_set(gl_FragCoord.y);</span>

<span class="s">    c_x = ds_add(ds_mul(frag_x, inv_resolution_x), -point5);</span>
<span class="s">    c_x = ds_add(ds_mul(c_x, scale), center_x);</span>
<span class="s">    c_y = ds_add(ds_mul(frag_y, inv_resolution_y), -point5);</span>
<span class="s">    c_y = ds_add(ds_mul(c_y, scale), center_y);</span>


<span class="s">    // Main Mandelbrot computation</span>
<span class="s">    int i;</span>
<span class="s">    z_x = c_x;</span>
<span class="s">    z_y = c_y;</span>
<span class="s">    for(i = 0; i &lt; iter; i++) {</span>
<span class="s">        x = ds_add(ds_add(ds_mul(z_x, z_x), -ds_mul(z_y, z_y)), c_x);</span>
<span class="s">        y = ds_add(ds_add(ds_mul(z_y, z_x), ds_mul(z_x, z_y)), c_y);</span>

<span class="s">        if(ds_compare(ds_add(ds_mul(x, x), ds_mul(y, y)), four) &gt; 0.) break;</span>
<span class="s">        z_x = x;</span>
<span class="s">        z_y = y;</span>
<span class="s">    }</span>

<span class="s">    // Convert iterations to color</span>
<span class="s">    float color = 1.0 - float(i) / float(iter);</span>
<span class="s">    gl_FragColor = color_scheme(color);</span>

<span class="s">}</span>
<span class="s">&quot;&quot;&quot;</span>


<span class="c"># vispy Canvas</span>
<span class="c"># -----------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">Canvas</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">Canvas</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">Canvas</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">gloo</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="n">fragment</span><span class="p">)</span>

        <span class="c"># Draw a rectangle that takes up the whole screen. All of the work is</span>
        <span class="c"># done in the shader.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_emulated_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_center</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&quot;iter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">300</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">apply_zoom</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">min_scale</span> <span class="o">=</span> <span class="mf">1e-12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_scale</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">gloo</span><span class="o">.</span><span class="n">set_clear_color</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_zoom</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">apply_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_size</span>
        <span class="n">gloo</span><span class="o">.</span><span class="n">set_viewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;inv_resolution_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_emulated_double</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;inv_resolution_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_emulated_double</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_mouse_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pan the view based on the change in mouse position.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_dragging</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">last_event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">event</span><span class="o">.</span><span class="n">last_event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">X0</span><span class="p">,</span> <span class="n">Y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_to_coords</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y0</span><span class="p">))</span>
            <span class="n">X1</span><span class="p">,</span> <span class="n">Y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_to_coords</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">translate_center</span><span class="p">(</span><span class="n">X1</span> <span class="o">-</span> <span class="n">X0</span><span class="p">,</span> <span class="n">Y1</span> <span class="o">-</span> <span class="n">Y0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">translate_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Translates the center point, and keeps it in bounds.&quot;&quot;&quot;</span>
        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>
        <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
        <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dy</span>
        <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>

        <span class="n">center_x</span> <span class="o">=</span> <span class="n">set_emulated_double</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">center_y</span> <span class="o">=</span> <span class="n">set_emulated_double</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&quot;center_x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&quot;center_y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_y</span>

    <span class="k">def</span> <span class="nf">pixel_to_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert pixel coordinates to Mandelbrot set coordinates.&quot;&quot;&quot;</span>
        <span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">rx</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="p">((</span><span class="n">ry</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">ry</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">on_mouse_wheel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the mouse wheel to zoom.&quot;&quot;&quot;</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># Zoom in</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="k">elif</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c"># Zoom out</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">0.9</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_key_press</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use + or - to zoom in and out.</span>

<span class="sd">        The mouse wheel can be used to zoom, but some people don&#39;t have mouse</span>
<span class="sd">        wheels :)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span> <span class="ow">or</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">&#39;=&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span> <span class="n">mouse_coords</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Factors less than zero zoom in, and greater than zero zoom out.</span>

<span class="sd">        If mouse_coords is given, the point under the mouse stays stationary</span>
<span class="sd">        while zooming. mouse_coords should come from MouseEvent.pos.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mouse_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># Record the position of the mouse</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mouse_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">mouse_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_to_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*=</span> <span class="n">factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_scale</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_scale</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&quot;scale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_emulated_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mouse_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># Translate so mouse point is stationary</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pixel_to_coords</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">translate_center</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_emulated_double</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Emulate a double using two numbers of type float32.&quot;&quot;&quot;</span>
    <span class="n">double</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">number</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="c"># Cast number to float32</span>
    <span class="n">double</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span> <span class="o">-</span> <span class="n">double</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c"># Remainder stored in second half of array</span>
    <span class="k">return</span> <span class="n">double</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span> <span class="n">keys</span><span class="o">=</span><span class="s">&#39;interactive&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>


        </div>
        <div class="span3">

<div class="clearfix"></div> <h4 class="sidebar-box-heading">Download</h4>
<div class="well sidebar-box">
    <ul class="nav nav-list">
        <li><a class="reference external"
                href="https://pypi.python.org/pypi/vispy">Latest release from Pypi</a></li>
        <li><a href="https://github.com/vispy/vispy/archive/master.zip">Bleeding edge</a></li>
    </ul>
</div>
<h4 class="sidebar-box-heading">Links</h4>
<div class="well sidebar-box">
    <ul class="nav nav-list">
        <li><a class="reference external"
                href="https://github.com/vispy/vispy/issues">Issue tracker</a></li>
        <li><a class="reference external"
                href="https://github.com/vispy/vispy/wiki">Project wiki</a></li>
        <li><a class="reference external"
                href="http://groups.google.com/group/vispy">User mailing list</a></li>
        <li><a class="reference external"
                href="http://groups.google.com/group/vispy-dev">Dev mailing list</a></li>
        <li><a class="reference external"
                href="https://gitter.im/vispy/vispy">Dev chat room</a></li>
    </ul>
</div>
<h4 class="sidebar-box-heading">Related Projects</h4>
<div class="well sidebar-box">
    <ul class="nav nav-list">
        <li><a class="reference external"
                href="http://pyopengl.sourceforge.net/">PyOpenGL</a></li>
        <li><a class="reference external"
                href="http://www.pyqtgraph.org/">PyQtGraph</a></li>
        <li><a class="reference external"
                href="http://rossant.github.io/galry/">Galry</a></li>
        <li><a class="reference external"
                href="http://code.google.com/p/glumpy/">Glumpy</a></li>
        <li><a class="reference external"
                href="http://code.google.com/p/visvis/">Visvis</a></li>
    </ul>
</div>
        </div>
    </div>
    <div class="well footer">
        <small>
            &copy; Copyright the vispy development team.
            Created using <a href="http://twitter.github.com/bootstrap/">Bootstrap</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.
            Theme by <a href="http://scikit-image.org/">scikit-image</a>.
        </small>
    </div>
</body>
</html>