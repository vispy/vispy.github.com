


<!DOCTYPE html>
<html lang="en">
<head>
        <title>demo/gloo/shadertoy &mdash; vispy</title>
    
    
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link href="../../../_static/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../../../_static/css/custom.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">
    
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="../../../_static/js/bootstrap.min.js"></script>
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/js/jquery.anoslide.js"></script>
        <script type="text/javascript" src="../../../_static/js/carousel.js"></script>
        <link rel="top" title="vispy" href="../../../index.html" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="shortcut icon" href="../../../_static/favicon.ico">
</head>
<body class="container">
    <a href="http://vispy.org" class="logo"><img src="../../../_static/img/logo.png" alt=""></a>
    <div class="clearfix"></div>
    <div class="navbar">
        <div class="navbar-inner">
            <ul class="nav">
                <li><a href="http://vispy.org/index.html">Home</a></li>
<li><a href="http://vispy.org/gallery.html">Gallery</a></li>
<li><a href="http://api.vispy.org">Documentation</a></li>
<li><a href="https://github.com/vispy/vispy">Source</a></li>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45168532-1', 'vispy.org');
  ga('send', 'pageview');

</script>
            </ul>
            <form class="navbar-form pull-right" action="http://api.vispy.org/en/latest/search.html" method="get">
                <input type="text" class="search span3" name="q" placeholder="Search documentation ...">
                <input type="hidden" name="check_keywords" value="yes" >
                <input type="hidden" name="area" value="default" >
            </form>
        </div>
    </div>
    <div class="row">
        <div class="span9">
            
  <div class="section" id="demo-gloo-shadertoy">
<h1>demo/gloo/shadertoy<a class="headerlink" href="#demo-gloo-shadertoy" title="Permalink to this headline">Â¶</a></h1>
<p>Shadertoy demo. You can copy-paste shader code from an example on
www.shadertoy.com and get the demo.</p>
<p>TODO: support cubes and videos as channel inputs (currently, only images
are supported).</p>
<img alt="../../../_images/demo__gloo__shadertoy.png" src="../../../_images/demo__gloo__shadertoy.png" />
<hr class="docutils" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example is based on <code class="docutils literal"><span class="pre">vispy.gloo</span></code> and thus uses GLSL
shading code, which is executed at the GPU and is
defined as multiline strings.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># NOTE: This example throws warnings about variables not being used;</span>
<span class="c"># this is normal because only some shadertoy examples make use of all</span>
<span class="c"># variables, and the GPU may compile some of them away.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">vispy</span> <span class="kn">import</span> <span class="n">gloo</span>
<span class="kn">from</span> <span class="nn">vispy</span> <span class="kn">import</span> <span class="n">app</span>


<span class="n">vertex</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">#version 120</span>

<span class="s">attribute vec2 position;</span>
<span class="s">void main()</span>
<span class="s">{</span>
<span class="s">    gl_Position = vec4(position, 0.0, 1.0);</span>
<span class="s">}</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="n">fragment</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">#version 120</span>

<span class="s">uniform vec3      iResolution;           // viewport resolution (in pixels)</span>
<span class="s">uniform float     iGlobalTime;           // shader playback time (in seconds)</span>
<span class="s">uniform vec4      iMouse;                // mouse pixel coords</span>
<span class="s">uniform vec4      iDate;                 // (year, month, day, time in seconds)</span>
<span class="s">uniform float     iSampleRate;           // sound sample rate (i.e., 44100)</span>
<span class="s">uniform sampler2D iChannel0;             // input channel. XX = 2D/Cube</span>
<span class="s">uniform sampler2D iChannel1;             // input channel. XX = 2D/Cube</span>
<span class="s">uniform sampler2D iChannel2;             // input channel. XX = 2D/Cube</span>
<span class="s">uniform sampler2D iChannel3;             // input channel. XX = 2D/Cube</span>
<span class="s">uniform vec3      iChannelResolution[4]; // channel resolution (in pixels)</span>
<span class="s">uniform float     iChannelTime[4];       // channel playback time (in sec)</span>

<span class="si">%s</span><span class="s"></span>
<span class="s">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">get_idate</span><span class="p">():</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">utcnow</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
    <span class="n">midnight_utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">utcnow</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">utcnow</span> <span class="o">-</span> <span class="n">midnight_utc</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">noise</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">nchannels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="c"># Random texture.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
                             <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">nchannels</span><span class="p">)</span>
                             <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Canvas</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">Canvas</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shadertoy</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">app</span><span class="o">.</span><span class="n">Canvas</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="s">&#39;interactive&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shadertoy</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">shadertoy</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            void main(void)</span>
<span class="s">            {</span>
<span class="s">                vec2 uv = gl_FragCoord.xy / iResolution.xy;</span>
<span class="s">                gl_FragColor = vec4(uv,0.5+0.5*sin(iGlobalTime),1.0);</span>
<span class="s">            }&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">gloo</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="n">fragment</span> <span class="o">%</span> <span class="n">shadertoy</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&quot;position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                                    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iMouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iSampleRate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">44100.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iChannelTime[</span><span class="si">%d</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">activate_zoom</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_timer</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_timer</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_channel_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">tex</span> <span class="o">=</span> <span class="n">gloo</span><span class="o">.</span><span class="n">Texture2D</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">tex</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="s">&#39;linear&#39;</span>
        <span class="n">tex</span><span class="o">.</span><span class="n">wrapping</span> <span class="o">=</span> <span class="s">&#39;repeat&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iChannel</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iChannelResolution[</span><span class="si">%d</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span> <span class="nf">on_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_mouse_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="c"># BUG: DOES NOT WORK YET, NO CLICK EVENT IN VISPY FOR NOW...</span>
        <span class="n">imouse</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iMouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imouse</span>

    <span class="k">def</span> <span class="nf">on_mouse_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_dragging</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">px</span><span class="p">,</span> <span class="n">py</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">press_event</span><span class="o">.</span><span class="n">pos</span>
            <span class="n">imouse</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">py</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iMouse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imouse</span>

    <span class="k">def</span> <span class="nf">on_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iGlobalTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_idate</span><span class="p">()</span>  <span class="c"># used in some shadertoy exs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">on_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_zoom</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">activate_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gloo</span><span class="o">.</span><span class="n">set_viewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span><span class="p">[</span><span class="s">&#39;iResolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physical_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">physical_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>

<span class="c"># -------------------------------------------------------------------------</span>
<span class="c"># COPY-PASTE SHADERTOY CODE BELOW</span>
<span class="c"># -------------------------------------------------------------------------</span>
<span class="n">SHADERTOY</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">// From: https://www.shadertoy.com/view/MdX3Rr</span>

<span class="s">// Created by inigo quilez - iq/2013</span>
<span class="s">// License Creative Commons Attribution-NonCommercial-ShareAlike 3.0</span>
<span class="s">// Unported License.</span>

<span class="s">//stereo thanks to Croqueteer</span>
<span class="s">//#define STEREO</span>

<span class="s">// value noise, and its analytical derivatives</span>
<span class="s">vec3 noised( in vec2 x )</span>
<span class="s">{</span>
<span class="s">    vec2 p = floor(x);</span>
<span class="s">    vec2 f = fract(x);</span>

<span class="s">    vec2 u = f*f*(3.0-2.0*f);</span>

<span class="s">    float a = texture2D(iChannel0,(p+vec2(0.5,0.5))/256.0,-100.0).x;</span>
<span class="s">    float b = texture2D(iChannel0,(p+vec2(1.5,0.5))/256.0,-100.0).x;</span>
<span class="s">    float c = texture2D(iChannel0,(p+vec2(0.5,1.5))/256.0,-100.0).x;</span>
<span class="s">    float d = texture2D(iChannel0,(p+vec2(1.5,1.5))/256.0,-100.0).x;</span>

<span class="s">    return vec3(a+(b-a)*u.x+(c-a)*u.y+(a-b-c+d)*u.x*u.y,</span>
<span class="s">                6.0*f*(1.0-f)*(vec2(b-a,c-a)+(a-b-c+d)*u.yx));</span>
<span class="s">}</span>

<span class="s">const mat2 m2 = mat2(0.8,-0.6,0.6,0.8);</span>

<span class="s">float terrain( in vec2 x )</span>
<span class="s">{</span>
<span class="s">    vec2  p = x*0.003;</span>
<span class="s">    float a = 0.0;</span>
<span class="s">    float b = 1.0;</span>
<span class="s">    vec2  d = vec2(0.0);</span>
<span class="s">    for( int i=0; i&lt;6; i++ )</span>
<span class="s">    {</span>
<span class="s">        vec3 n = noised(p);</span>
<span class="s">        d += n.yz;</span>
<span class="s">        a += b*n.x/(1.0+dot(d,d));</span>
<span class="s">        b *= 0.5;</span>
<span class="s">        p = m2*p*2.0;</span>
<span class="s">    }</span>

<span class="s">    return 140.0*a;</span>
<span class="s">}</span>

<span class="s">float terrain2( in vec2 x )</span>
<span class="s">{</span>
<span class="s">    vec2  p = x*0.003;</span>
<span class="s">    float a = 0.0;</span>
<span class="s">    float b = 1.0;</span>
<span class="s">    vec2  d = vec2(0.0);</span>
<span class="s">    for( int i=0; i&lt;14; i++ )</span>
<span class="s">    {</span>
<span class="s">        vec3 n = noised(p);</span>
<span class="s">        d += n.yz;</span>
<span class="s">        a += b*n.x/(1.0+dot(d,d));</span>
<span class="s">        b *= 0.5;</span>
<span class="s">        p=m2*p*2.0;</span>
<span class="s">    }</span>

<span class="s">    return 140.0*a;</span>
<span class="s">}</span>

<span class="s">float terrain3( in vec2 x )</span>
<span class="s">{</span>
<span class="s">    vec2  p = x*0.003;</span>
<span class="s">    float a = 0.0;</span>
<span class="s">    float b = 1.0;</span>
<span class="s">    vec2  d = vec2(0.0);</span>
<span class="s">    for( int i=0; i&lt;4; i++ )</span>
<span class="s">    {</span>
<span class="s">        vec3 n = noised(p);</span>
<span class="s">        d += n.yz;</span>
<span class="s">        a += b*n.x/(1.0+dot(d,d));</span>
<span class="s">        b *= 0.5;</span>
<span class="s">        p = m2*p*2.0;</span>
<span class="s">    }</span>

<span class="s">    return 140.0*a;</span>
<span class="s">}</span>

<span class="s">float map( in vec3 p )</span>
<span class="s">{</span>
<span class="s">    float h = terrain(p.xz);</span>
<span class="s">    return p.y - h;</span>
<span class="s">}</span>

<span class="s">float map2( in vec3 p )</span>
<span class="s">{</span>
<span class="s">    float h = terrain2(p.xz);</span>
<span class="s">    return p.y - h;</span>
<span class="s">}</span>

<span class="s">float interesct( in vec3 ro, in vec3 rd )</span>
<span class="s">{</span>
<span class="s">    float h = 1.0;</span>
<span class="s">    float t = 1.0;</span>
<span class="s">    for( int i=0; i&lt;120; i++ )</span>
<span class="s">    {</span>
<span class="s">        if( h&lt;0.01 || t&gt;2000.0 ) break;</span>
<span class="s">        t += 0.5*h;</span>
<span class="s">        h = map( ro + t*rd );</span>
<span class="s">    }</span>

<span class="s">    if( t&gt;2000.0 ) t = -1.0;</span>
<span class="s">    return t;</span>
<span class="s">}</span>

<span class="s">float sinteresct(in vec3 ro, in vec3 rd )</span>
<span class="s">{</span>
<span class="s">#if 0</span>
<span class="s">    // no shadows</span>
<span class="s">    return 1.0;</span>
<span class="s">#endif</span>

<span class="s">#if 0</span>
<span class="s">    // fake shadows</span>
<span class="s">    vec3 nor;</span>
<span class="s">    vec3  eps = vec3(20.0,0.0,0.0);</span>
<span class="s">    nor.x = terrain3(ro.xz-eps.xy) - terrain3(ro.xz+eps.xy);</span>
<span class="s">    nor.y = 1.0*eps.x;</span>
<span class="s">    nor.z = terrain3(ro.xz-eps.yx) - terrain3(ro.xz+eps.yx);</span>
<span class="s">    nor = normalize(nor);</span>
<span class="s">    return clamp( 4.0*dot(nor,rd), 0.0, 1.0 );</span>
<span class="s">#endif</span>

<span class="s">#if 1</span>
<span class="s">    // real shadows</span>
<span class="s">    float res = 1.0;</span>
<span class="s">    float t = 0.0;</span>
<span class="s">    for( int j=0; j&lt;48; j++ )</span>
<span class="s">    {</span>
<span class="s">        vec3 p = ro + t*rd;</span>
<span class="s">        float h = map( p );</span>
<span class="s">        res = min( res, 16.0*h/t );</span>
<span class="s">        t += h;</span>
<span class="s">        if( res&lt;0.001 ||p.y&gt;300.0 ) break;</span>
<span class="s">    }</span>

<span class="s">    return clamp( res, 0.0, 1.0 );</span>
<span class="s">#endif</span>
<span class="s">}</span>

<span class="s">vec3 calcNormal( in vec3 pos, float t )</span>
<span class="s">{</span>
<span class="s">    float e = 0.001;</span>
<span class="s">    e = 0.001*t;</span>
<span class="s">    vec3  eps = vec3(e,0.0,0.0);</span>
<span class="s">    vec3 nor;</span>
<span class="s">#if 0</span>
<span class="s">    nor.x = map2(pos+eps.xyy) - map2(pos-eps.xyy);</span>
<span class="s">    nor.y = map2(pos+eps.yxy) - map2(pos-eps.yxy);</span>
<span class="s">    nor.z = map2(pos+eps.yyx) - map2(pos-eps.yyx);</span>
<span class="s">#else</span>
<span class="s">    nor.x = terrain2(pos.xz-eps.xy) - terrain2(pos.xz+eps.xy);</span>
<span class="s">    nor.y = 2.0*e;</span>
<span class="s">    nor.z = terrain2(pos.xz-eps.yx) - terrain2(pos.xz+eps.yx);</span>
<span class="s">#endif</span>
<span class="s">    return normalize(nor);</span>
<span class="s">}</span>

<span class="s">vec3 camPath( float time )</span>
<span class="s">{</span>
<span class="s">    vec2 p = 1100.0*vec2( cos(0.0+0.23*time), cos(1.5+0.21*time) );</span>

<span class="s">    return vec3( p.x, 0.0, p.y );</span>
<span class="s">}</span>


<span class="s">float fbm( vec2 p )</span>
<span class="s">{</span>
<span class="s">    float f = 0.0;</span>

<span class="s">    f += 0.5000*texture2D( iChannel0, p/256.0 ).x; p = m2*p*2.02;</span>
<span class="s">    f += 0.2500*texture2D( iChannel0, p/256.0 ).x; p = m2*p*2.03;</span>
<span class="s">    f += 0.1250*texture2D( iChannel0, p/256.0 ).x; p = m2*p*2.01;</span>
<span class="s">    f += 0.0625*texture2D( iChannel0, p/256.0 ).x;</span>

<span class="s">    return f/0.9375;</span>
<span class="s">}</span>


<span class="s">void main(void)</span>
<span class="s">{</span>
<span class="s">    vec2 xy = -1.0 + 2.0*gl_FragCoord.xy / iResolution.xy;</span>

<span class="s">    vec2 s = xy*vec2(iResolution.x/iResolution.y,1.0);</span>

<span class="s">    #ifdef STEREO</span>
<span class="s">    float isCyan = mod(gl_FragCoord.x + mod(gl_FragCoord.y,2.0),2.0);</span>
<span class="s">    #endif</span>

<span class="s">    float time = iGlobalTime*0.15 + 0.3 + 4.0*iMouse.x/iResolution.x;</span>

<span class="s">    vec3 light1 = normalize( vec3(-0.8,0.4,-0.3) );</span>



<span class="s">    vec3 ro = camPath( time );</span>
<span class="s">    vec3 ta = camPath( time + 3.0 );</span>
<span class="s">    ro.y = terrain3( ro.xz ) + 11.0;</span>
<span class="s">    ta.y = ro.y - 20.0;</span>

<span class="s">    float cr = 0.2*cos(0.1*time);</span>
<span class="s">    vec3  cw = normalize(ta-ro);</span>
<span class="s">    vec3  cp = vec3(sin(cr), cos(cr),0.0);</span>
<span class="s">    vec3  cu = normalize( cross(cw,cp) );</span>
<span class="s">    vec3  cv = normalize( cross(cu,cw) );</span>
<span class="s">    vec3  rd = normalize( s.x*cu + s.y*cv + 2.0*cw );</span>

<span class="s">    #ifdef STEREO</span>
<span class="s">    ro += 2.0*cu*isCyan;</span>
<span class="s">    #endif</span>

<span class="s">    float sundot = clamp(dot(rd,light1),0.0,1.0);</span>
<span class="s">    vec3 col;</span>
<span class="s">    float t = interesct( ro, rd );</span>
<span class="s">    if( t&lt;0.0 )</span>
<span class="s">    {</span>
<span class="s">        // sky</span>
<span class="s">        col = vec3(0.3,.55,0.8)*(1.0-0.8*rd.y);</span>
<span class="s">        col += 0.25*vec3(1.0,0.7,0.4)*pow( sundot,5.0 );</span>
<span class="s">        col += 0.25*vec3(1.0,0.8,0.6)*pow( sundot,64.0 );</span>
<span class="s">        col += 0.2*vec3(1.0,0.8,0.6)*pow( sundot,512.0 );</span>
<span class="s">        vec2 sc = ro.xz + rd.xz*(1000.0-ro.y)/rd.y;</span>
<span class="s">        col = mix( col, vec3(1.0,0.95,1.0),</span>
<span class="s">            0.5*smoothstep(0.5,0.8,fbm(0.0005*sc)) );</span>
<span class="s">    }</span>
<span class="s">    else</span>
<span class="s">    {</span>
<span class="s">        // mountains</span>
<span class="s">        vec3 pos = ro + t*rd;</span>

<span class="s">        vec3 nor = calcNormal( pos, t );</span>

<span class="s">        float r = texture2D( iChannel0, 7.0*pos.xz/256.0 ).x;</span>

<span class="s">        col = (r*0.25+0.75)*0.9*mix( vec3(0.08,0.05,0.03),</span>
<span class="s">            vec3(0.10,0.09,0.08), texture2D(iChannel0,0.00007*vec2(</span>
<span class="s">                pos.x,pos.y*48.0)).x );</span>
<span class="s">        col = mix( col, 0.20*vec3(0.45,.30,0.15)*(0.50+0.50*r),</span>
<span class="s">            smoothstep(0.70,0.9,nor.y) );</span>
<span class="s">        col = mix( col, 0.15*vec3(0.30,.30,0.10)*(0.25+0.75*r),</span>
<span class="s">            smoothstep(0.95,1.0,nor.y) );</span>

<span class="s">        // snow</span>
<span class="s">        float h = smoothstep(55.0,80.0,pos.y + 25.0*fbm(0.01*pos.xz) );</span>
<span class="s">        float e = smoothstep(1.0-0.5*h,1.0-0.1*h,nor.y);</span>
<span class="s">        float o = 0.3 + 0.7*smoothstep(0.0,0.1,nor.x+h*h);</span>
<span class="s">        float s = h*e*o;</span>
<span class="s">        col = mix( col, 0.29*vec3(0.62,0.65,0.7), smoothstep(</span>
<span class="s">            0.1, 0.9, s ) );</span>

<span class="s">         // lighting</span>
<span class="s">        float amb = clamp(0.5+0.5*nor.y,0.0,1.0);</span>
<span class="s">        float dif = clamp( dot( light1, nor ), 0.0, 1.0 );</span>
<span class="s">        float bac = clamp( 0.2 + 0.8*dot( normalize(</span>
<span class="s">            vec3(-light1.x, 0.0, light1.z ) ), nor ), 0.0, 1.0 );</span>
<span class="s">        float sh = 1.0; if( dif&gt;=0.0001 ) sh = sinteresct(</span>
<span class="s">            pos+light1*20.0,light1);</span>

<span class="s">        vec3 lin  = vec3(0.0);</span>
<span class="s">        lin += dif*vec3(7.00,5.00,3.00)*vec3( sh, sh*sh*0.5+0.5*sh,</span>
<span class="s">            sh*sh*0.8+0.2*sh );</span>
<span class="s">        lin += amb*vec3(0.40,0.60,0.80)*1.5;</span>
<span class="s">        lin += bac*vec3(0.40,0.50,0.60);</span>
<span class="s">        col *= lin;</span>


<span class="s">        float fo = 1.0-exp(-0.0005*t);</span>
<span class="s">        vec3 fco = 0.55*vec3(0.55,0.65,0.75) + 0.1*vec3(1.0,0.8,0.5)*pow(</span>
<span class="s">            sundot, 4.0 );</span>
<span class="s">        col = mix( col, fco, fo );</span>

<span class="s">        col += 0.3*vec3(1.0,0.8,0.4)*pow( sundot,</span>
<span class="s">                    8.0 )*(1.0-exp(-0.002*t));</span>
<span class="s">    }</span>

<span class="s">    col = pow(col,vec3(0.4545));</span>

<span class="s">    // vignetting</span>
<span class="s">    col *= 0.5 + 0.5*pow( (xy.x+1.0)*(xy.y+1.0)*(xy.x-1.0)*(xy.y-1.0),</span>
<span class="s">                         0.1 );</span>

<span class="s">    #ifdef STEREO</span>
<span class="s">    col *= vec3( isCyan, 1.0-isCyan, 1.0-isCyan );</span>
<span class="s">    #endif</span>

<span class="s">//  col *= smoothstep( 0.0, 2.0, iGlobalTime );</span>

<span class="s">    gl_FragColor=vec4(col,1.0);</span>
<span class="s">}</span>
<span class="s">&quot;&quot;&quot;</span>
<span class="c"># -------------------------------------------------------------------------</span>

<span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="n">SHADERTOY</span><span class="p">)</span>
<span class="c"># Input data.</span>
<span class="n">canvas</span><span class="o">.</span><span class="n">set_channel_input</span><span class="p">(</span><span class="n">noise</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">nchannels</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">canvas</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">interactive</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>


        </div>
        <div class="span3">

<div class="clearfix"></div> <h4 class="sidebar-box-heading">Download</h4>
<div class="well sidebar-box">
    <ul class="nav nav-list">
        <li><a class="reference external"
                href="https://pypi.python.org/pypi/vispy">Latest release from Pypi</a></li>
        <li><a href="https://github.com/vispy/vispy/archive/master.zip">Bleeding edge</a></li>
    </ul>
</div>
<h4 class="sidebar-box-heading">Links</h4>
<div class="well sidebar-box">
    <ul class="nav nav-list">
        <li><a class="reference external"
                href="https://github.com/vispy/vispy/issues">Issue tracker</a></li>
        <li><a class="reference external"
                href="https://github.com/vispy/vispy/wiki">Project wiki</a></li>
        <li><a class="reference external"
                href="http://groups.google.com/group/vispy">User mailing list</a></li>
        <li><a class="reference external"
                href="http://groups.google.com/group/vispy-dev">Dev mailing list</a></li>
        <li><a class="reference external"
                href="https://gitter.im/vispy/vispy">Dev chat room</a></li>
    </ul>
</div>
<h4 class="sidebar-box-heading">Related Projects</h4>
<div class="well sidebar-box">
    <ul class="nav nav-list">
        <li><a class="reference external"
                href="http://pyopengl.sourceforge.net/">PyOpenGL</a></li>
        <li><a class="reference external"
                href="http://www.pyqtgraph.org/">PyQtGraph</a></li>
        <li><a class="reference external"
                href="http://rossant.github.io/galry/">Galry</a></li>
        <li><a class="reference external"
                href="http://code.google.com/p/glumpy/">Glumpy</a></li>
        <li><a class="reference external"
                href="http://code.google.com/p/visvis/">Visvis</a></li>
    </ul>
</div>
        </div>
    </div>
    <div class="well footer">
        <small>
            &copy; Copyright the vispy development team.
            Created using <a href="http://twitter.github.com/bootstrap/">Bootstrap</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.
            Theme by <a href="http://scikit-image.org/">scikit-image</a>.
        </small>
    </div>
</body>
</html>